# Технічне завдання на розробку системи автоматичної торгівлі на основі сигналів з телеграм-каналів

## 1. Загальний опис проєкту

Система призначена для моніторингу _одного цільового_ телеграм-чату, куди вручну пересилаються сигнали з різних каналів (попередньо налаштованих), та автоматичного виконання торгових операцій на криптовалютній біржі BingX відповідно до цих сигналів.

## 2. Архітектура проєкту

Проєкт складається з наступних модулів:

1.  `telegram_monitor.py`: Модуль моніторингу Телеграм (налаштування та запуск бота).
2.  `signal_interpreter.py`: Модуль інтерпретації сигналів (парсинг текстів).
3.  `bingx_client.py`: Модуль взаємодії з BingX API (через `ccxt`).
4.  `data_manager.py`: Модуль зберігання даних (робота з БД SQLite).
5.  `position_manager.py`: Модуль управління позиціями (моніторинг, спроба БЗ).
6.  `main.py`: Головний модуль (координатор, обробка повідомлень).

## 3. Конфігурація системи

Система використовує два файли конфігурації:

- `config.json`: Містить основні параметри торгівлі:
  - `global_settings`: Розмір загального банку (`total_bankroll`).
  - `channels`: Налаштування для кожного каналу (точна назва `name`, відсоток банку `entry_percentage`, розподіл `tp_distribution`, кредитне плече `leverage`).
  - `position_limits`: Максимальна кількість відкритих позицій для груп каналів.
- `.env`: Містить чутливі дані:
  - `BINGX_API_KEY`, `BINGX_API_SECRET`: Ключі доступу до API BingX.
  - `TELEGRAM_BOT_TOKEN`: Токен вашого Telegram бота.
  - `TELEGRAM_TARGET_CHAT_ID`: ID цільового чату, куди пересилаються сигнали.

## 4. Детальні умови для кожного каналу, з якого надсилаються сигнали

### 4.1. Канал 1: "VIP марафон | Даниэль"

#### Формат сигналу:

_(Описаний у `signal_interpreter.py`, парсер `parse_channel_1_details`)_

#### Логіка обробки:

1.  Вхід у ринок через Market Order.
2.  Встановлення стоп-лосс згідно зі значенням у сигналі.
3.  Встановлення тейк-профітів згідно з `tp_distribution` з `config.json`.
4.  При досягненні TP1:
    - Спроба переведення стоп-лосс у беззбитковість (БЗ) через `edit_order`. (_Примітка: працездатність залежить від підтримки API BingX та `ccxt`_).
    - _Примітка: Логіка звільнення слоту при переведенні в БЗ ще не реалізована._
5.  Розмір угоди: згідно з `entry_percentage` з `config.json`.

### 4.2. Канал 2: "Crypto Alliance | Мартин"

#### Формат сигналу:

_(Описаний у `signal_interpreter.py`, парсер `parse_channel_2`)_

#### Логіка обробки:

1.  Вхід у ринок через Market Order.
2.  Встановлення стоп-лосс згідно зі значенням у сигналі.
3.  Встановлення тейк-профітів згідно з `tp_distribution` з `config.json`.
4.  При досягненні TP1:
    - Спроба переведення стоп-лосс у БЗ через `edit_order`. (_Примітка: працездатність залежить від підтримки API BingX та `ccxt`_).
    - _Примітка: Логіка звільнення слоту при переведенні в БЗ ще не реалізована._
5.  Розмір угоди: згідно з `entry_percentage` з `config.json`.

### 4.3. Канал 3: "Внутри графика с Джимми"

#### Формат сигналу:

_(Описаний у `signal_interpreter.py`, парсер `parse_channel_3`)_

#### Логіка обробки:

1.  **Вхід у ринок через Limit Order** по нижній межі діапазону ціни, вказаного у сигналі.
2.  Встановлення стоп-лосс згідно зі значенням у сигналі.
3.  Встановлення тейк-профітів згідно з `tp_distribution` з `config.json`.
4.  При досягненні TP1:
    - Спроба переведення стоп-лосс у БЗ через `edit_order`. (_Примітка: працездатність залежить від підтримки API BingX та `ccxt`_).
    - Скасування пов'язаного лімітного ордера (реалізовано в `position_manager`).
5.  Розмір угоди: згідно з `entry_percentage` з `config.json`.

### 4.4. Канал 4: "KostyaKogan"

#### Формат сигналу:

_(Описаний у `signal_interpreter.py`, парсер `parse_channel_4`)_

#### Логіка обробки:

1.  Вхід у ринок через Market Order.
2.  Встановлення стоп-лосс згідно зі значенням у сигналі.
3.  Встановлення тейк-профітів згідно з `tp_distribution` з `config.json`.
4.  При досягненні TP1:
    - Спроба переведення стоп-лосс у БЗ через `edit_order`. (_Примітка: працездатність залежить від підтримки API BingX та `ccxt`_).
    - _Примітка: Логіка звільнення слоту при переведенні в БЗ ще не реалізована._
5.  Розмір угоди: згідно з `entry_percentage` з `config.json`.

## 5. Обмеження на кількість відкритих угод

1.  Для каналів 1, 2 і 4 (група `group_1_2_4`) — сумарно максимум відкритих позицій, що задається в `config.json` (`position_limits.group_1_2_4_max_open`).
2.  Якщо ліміт для групи досягнуто, нові сигнали для каналів цієї групи ігноруються до вивільнення слоту.
3.  _Примітка: Логіка автоматичного звільнення слоту при переведенні угоди в беззбитковість (після досягнення TP1) на даний момент не реалізована._
4.  Для каналу 3 — кількість одночасно відкритих позицій налаштовується окремо в `config.json` (`channels.channel_3.max_open_positions`), без впливу на ліміт групи 1, 2 і 4.

## 6. Модуль моніторингу Телеграм (`telegram_monitor.py`)

1.  Система підключається до одного цільового чату (ID вказано в `TELEGRAM_TARGET_CHAT_ID` в `.env`), куди користувач пересилає повідомлення з каналів, що моніторяться.
2.  Автоматичне відстеження нових повідомлень в цільовому чаті.
3.  Розпізнавання джерела сигналу за _назвою каналу_, що вказується Telegram при пересиланні (має співпадати з полем `name` в `config.json`).
4.  Передача тексту повідомлення та інформації про канал в `main.py` для подальшої обробки.

## 7. Модуль виконання угод на BingX (`bingx_client.py`)

1.  Підключення до API BingX (через `ccxt`) для виконання торгових операцій.
2.  Виконання Market Order або Limit Order (для Каналу 3) для входу в позицію.
3.  Встановлення Stop Loss (`STOP_MARKET`) та Take Profit (`TAKE_PROFIT_MARKET`) ордерів відповідно до сигналу.
4.  Спроба модифікації Stop Loss ордера (`edit_order`) для переведення в БЗ (_Примітка: Працездатність залежить від API біржі_).
5.  Скасування ордерів.
6.  Отримання інформації про ордери та позиції (використовується `position_manager`).

## 8. Модуль зберігання даних та аналітики (`data_manager.py`, `positions.sqlite`, `bot.log`)

1.  Використання бази даних SQLite (`positions.sqlite`) для зберігання інформації про активні та закриті позиції (ID позиції, символ, напрямок, ціна входу, обсяги, ID пов'язаних ордерів SL/TP/Limit, статус).
2.  Ведення детального журналу дій системи (рівень DEBUG) у файлі `bot.log` для відстеження подій та діагностики помилок.
3.  _Примітка: Зберігання текстів усіх отриманих сигналів та розрахунок детальної статистики ефективності по кожному каналу на даний момент не реалізовано._

## 9. Вимоги до технічної реалізації

1.  Мова програмування: Python 3.
2.  Використання віртуального середовища (`venv`) для управління залежностями (`requirements.txt`).
3.  Модульна архітектура.
4.  Обробка помилок та логування.
5.  Логування: Рівень INFO в консоль, рівень DEBUG у файл `bot.log`.

## 10. Тестування проєкту

### 10.1. Тестування модуля моніторингу Телеграм

- Перевірка підключення до цільового чату.
- Тестування розпізнавання джерел пересланих повідомлень.

### 10.2. Тестування модуля інтерпретації сигналів

- Перевірка коректності парсингу даних з кожного типу сигналу.
- Тестування на стійкість до помилок форматування.

### 10.3. Тестування модуля взаємодії з Bingx API

- Тестування виконання ринкових та лімітних ордерів.
- Тестування встановлення SL/TP ордерів.
- **Особлива увага:** Тестування функції `edit_order` для SL ордерів (перевірка підтримки біржею).
- Тестування скасування ордерів.

### 10.4. Тестування модуля зберігання даних

- Перевірка коректності запису та читання даних з `positions.sqlite`.

### 10.5. Тестування модуля управління позиціями

- Перевірка коректності моніторингу стану ордерів.
- Тестування логіки обробки спрацювання TP/SL.
- Тестування логіки спроби переведення в БЗ.

### 10.6. Тестування головного модуля

- Перевірка коректності взаємодії між всіма модулями.
- Тестування обробки помилок.
- Тестування дотримання обмежень на кількість відкритих угод.

### 10.7. Методи тестування

_(Без змін)_

### 10.8. Режими тестування

_(Без змін)_

## 11. Подальший розвиток системи

1.  Додавання веб-інтерфейсу для контролю та аналітики.
2.  Інтеграція з іншими біржами.
3.  Розширення функціоналу для обробки більшої кількості каналів (спрощено поточною архітектурою, але вимагає написання парсерів).
4.  Система сповіщень про виконання угод та помилки через Telegram.
5.  Реалізація надійного механізму переведення SL в БЗ (наприклад, через Cancel+Create, якщо `edit_order` не працює).
6.  Реалізація механізму автоматичного звільнення торгових слотів при переведенні позиції в БЗ.
7.  Зберігання текстів сигналів та розрахунок статистики ефективності каналів.

## 12. Приклад конфігураційного файлу

_(Без змін, лише додати `leverage` для повноти)_

```json
{
  "global_settings": {
    "total_bankroll": 1000, // Приклад
    "bingx_api_key": "YOUR_API_KEY", // КРАЩЕ ВИКОРИСТОВУВАТИ .env
    "bingx_api_secret": "YOUR_API_SECRET" // КРАЩЕ ВИКОРИСТОВУВАТИ .env
  },
  "channels": {
    "channel_1": {
      "name": "VIP марафон | Даниэль",
      "entry_percentage": 5,
      "tp_distribution": [30, 50, 20],
      "leverage": 10 // Приклад
    },
    "channel_2": {
      "name": "Crypto Alliance | Мартин",
      "entry_percentage": 5,
      "tp_distribution": [30, 50, 20],
      "leverage": 10
    },
    "channel_3": {
      "name": "Внутри графика с Джимми",
      "entry_percentage": 4,
      "tp_distribution": [70, 30],
      "max_open_positions": 3,
      "leverage": 5
    },
    "channel_4": {
      "name": "KostyaKogan",
      "entry_percentage": 5,
      "tp_distribution": [40, 40, 20],
      "leverage": 18
    }
  },
  "position_limits": {
    "group_1_2_4_max_open": 2
  }
}
```
